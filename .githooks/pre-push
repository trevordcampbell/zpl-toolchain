#!/usr/bin/env bash
#
# pre-push â€” Thorough checks before pushing.
# Runs clippy and tests. Skip with: git push --no-verify

set -e

echo "pre-push: running clippy..."
if ! PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1 cargo clippy --workspace --locked -- -D warnings; then
    echo ""
    echo "  Clippy found warnings. Fix them before pushing."
    echo ""
    exit 1
fi

echo "pre-push: running tests..."
if command -v cargo-nextest &>/dev/null; then
    cargo nextest run --workspace --locked --exclude zpl_toolchain_wasm --exclude zpl_toolchain_python
else
    cargo test --workspace --locked --exclude zpl_toolchain_wasm --exclude zpl_toolchain_python
fi

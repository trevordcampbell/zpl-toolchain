#!/usr/bin/env bash
#
# pre-commit â€” Checks before every commit.
# Runs parser-tables sync + formatting check, and runs clippy when Rust files are staged.

set -e

# Keep the embedded parser tables in sync with the generated copy.
# generated/ is gitignored, so we (re)generate when spec-related files change
# or when generated/parser_tables.json is missing.
regen_tables=0
while IFS= read -r path; do
    case "$path" in
        spec/*|crates/spec-compiler/*|crates/spec-tables/*|crates/diagnostics/spec/*)
            regen_tables=1
            break
            ;;
    esac
done < <(git diff --cached --name-only --diff-filter=ACMR)

if [ "$regen_tables" -eq 1 ] || [ ! -f generated/parser_tables.json ]; then
    echo "pre-commit: generating parser tables..."
    cargo run -q -p zpl_toolchain_spec_compiler -- build --spec-dir spec --out-dir generated
fi

if [ -f generated/parser_tables.json ] && [ -f crates/cli/data/parser_tables.json ] \
   && ! diff -q generated/parser_tables.json crates/cli/data/parser_tables.json >/dev/null 2>&1; then
    echo "pre-commit: syncing parser tables to crates/cli/data/..."
    cp generated/parser_tables.json crates/cli/data/parser_tables.json
    git add crates/cli/data/parser_tables.json
fi

echo "pre-commit: checking formatting..."
if ! cargo fmt --all -- --check; then
    echo ""
    echo "  Formatting check failed. Run 'cargo fmt' to fix, then re-stage."
    echo ""
    exit 1
fi

rust_changes=0
while IFS= read -r path; do
    case "$path" in
        *.rs|Cargo.toml|Cargo.lock)
            rust_changes=1
            break
            ;;
    esac
done < <(git diff --cached --name-only --diff-filter=ACMR)

if [ "$rust_changes" -eq 1 ]; then
    echo "pre-commit: running clippy..."
    if ! PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1 cargo clippy --workspace --locked -- -D warnings; then
        echo ""
        echo "  Clippy found warnings. Fix them before committing."
        echo ""
        exit 1
    fi
fi

extension_changes=0
while IFS= read -r path; do
    case "$path" in
        packages/vscode-extension/*)
            extension_changes=1
            break
            ;;
    esac
done < <(git diff --cached --name-only --diff-filter=ACMR)

if [ "$extension_changes" -eq 1 ]; then
    if ! command -v npm &>/dev/null; then
        echo ""
        echo "  npm is required to validate vscode-extension changes."
        echo ""
        exit 1
    fi

    echo "pre-commit: running vscode-extension typecheck..."
    if ! (cd packages/vscode-extension && npm run typecheck); then
        echo ""
        echo "  VS Code extension type-check failed. Fix errors before committing."
        echo ""
        exit 1
    fi
fi

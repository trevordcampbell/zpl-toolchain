#!/usr/bin/env bash
#
# pre-push â€” Thorough checks before pushing.
# Runs clippy and tests. Skip with: git push --no-verify

set -e

EXCLUDE="--exclude zpl_toolchain_wasm --exclude zpl_toolchain_python"

echo "pre-push: running clippy..."
if ! cargo clippy --workspace --locked $EXCLUDE -- -D warnings; then
    echo ""
    echo "  Clippy found warnings. Fix them before pushing."
    echo ""
    exit 1
fi

echo "pre-push: running tests..."
if command -v cargo-nextest &>/dev/null; then
    cargo nextest run --workspace --locked $EXCLUDE
else
    cargo test --workspace --locked $EXCLUDE
fi

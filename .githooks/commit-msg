#!/usr/bin/env bash
#
# commit-msg â€” Enforce Conventional Commits format.
# Required by release-plz for automatic version bumps + changelog generation.
# https://www.conventionalcommits.org

MSG=$(head -1 "$1")

# Allow merge commits (auto-generated by git)
if echo "$MSG" | grep -qE "^Merge "; then
    exit 0
fi

if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?(!)?: .+"; then
    echo ""
    echo "  ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "  Expected:  type(scope): description"
    echo "  Got:       $MSG"
    echo ""
    echo "  Types: feat  fix  docs  style  refactor  perf  test  build  ci  chore  revert"
    echo ""
    echo "  Examples:"
    echo "    feat: add barcode validation"
    echo "    fix(parser): handle empty label blocks"
    echo "    feat!: redesign AST node structure"
    echo "    docs: update PUBLISH_PLAN.md"
    echo ""
    exit 1
fi
